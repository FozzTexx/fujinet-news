/**
 * @brief   FujiNet News Reader for MS-DOS
 * @author  Thomas Cherryhomes
 * @email   thom dot cherryhomes at gmail dot com
 * @license gpl v. 3, see LICENSE for details.
 * @verbose articles module
 */

#include <stdlib.h>
#include <string.h>
#include "screen.h"
#include "globals.h"
#include "select.h"

// Test fixture
unsigned char articles_data[] =
{
  0x31, 0x2f, 0x35, 0x0a, 0x34, 0x38, 0x36, 0x39, 0x39, 0x30, 0x7c, 0x32,
  0x30, 0x32, 0x35, 0x2d, 0x30, 0x35, 0x2d, 0x31, 0x30, 0x20, 0x32, 0x31,
  0x3a, 0x30, 0x31, 0x3a, 0x33, 0x39, 0x7c, 0x57, 0x6f, 0x72, 0x6b, 0x20,
  0x74, 0x6f, 0x20, 0x72, 0x65, 0x70, 0x6c, 0x61, 0x63, 0x65, 0x20, 0x31,
  0x34, 0x32, 0x2d, 0x79, 0x65, 0x61, 0x72, 0x2d, 0x6f, 0x6c, 0x64, 0x20,
  0x77, 0x61, 0x74, 0x65, 0x72, 0x6d, 0x61, 0x69, 0x6e, 0x20, 0x74, 0x6f,
  0x20, 0x63, 0x6c, 0x6f, 0x73, 0x65, 0x20, 0x64, 0x6f, 0x77, 0x6e, 0x74,
  0x6f, 0x77, 0x6e, 0x20, 0x69, 0x6e, 0x74, 0x65, 0x72, 0x73, 0x65, 0x63,
  0x74, 0x69, 0x6f, 0x6e, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x33, 0x20, 0x6d,
  0x6f, 0x6e, 0x74, 0x68, 0x73, 0x0a, 0x34, 0x38, 0x36, 0x39, 0x38, 0x38,
  0x7c, 0x32, 0x30, 0x32, 0x35, 0x2d, 0x30, 0x35, 0x2d, 0x31, 0x30, 0x20,
  0x31, 0x37, 0x3a, 0x34, 0x38, 0x3a, 0x35, 0x38, 0x7c, 0x45, 0x6d, 0x6d,
  0x61, 0x20, 0x52, 0x61, 0x64, 0x75, 0x63, 0x61, 0x6e, 0x75, 0x20, 0x72,
  0x61, 0x63, 0x65, 0x73, 0x20, 0x69, 0x6e, 0x74, 0x6f, 0x20, 0x4c, 0x61,
  0x73, 0x74, 0x20, 0x33, 0x32, 0x20, 0x64, 0x65, 0x73, 0x70, 0x69, 0x74,
  0x65, 0x20, 0x6c, 0x61, 0x74, 0x65, 0x20, 0x6f, 0x70, 0x70, 0x6f, 0x6e,
  0x65, 0x6e, 0x74, 0x20, 0x63, 0x68, 0x61, 0x6e, 0x67, 0x65, 0x0a, 0x34,
  0x38, 0x36, 0x39, 0x38, 0x34, 0x7c, 0x32, 0x30, 0x32, 0x35, 0x2d, 0x30,
  0x35, 0x2d, 0x31, 0x30, 0x20, 0x31, 0x35, 0x3a, 0x30, 0x37, 0x3a, 0x34,
  0x38, 0x7c, 0x53, 0x6f, 0x75, 0x74, 0x68, 0x20, 0x4b, 0x6f, 0x72, 0x65,
  0x61, 0x6e, 0x20, 0x74, 0x65, 0x6d, 0x70, 0x6c, 0x65, 0x20, 0x72, 0x65,
  0x74, 0x75, 0x72, 0x6e, 0x73, 0x20, 0x73, 0x74, 0x6f, 0x6c, 0x65, 0x6e,
  0x20, 0x42, 0x75, 0x64, 0x64, 0x68, 0x61, 0x20, 0x73, 0x74, 0x61, 0x74,
  0x75, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x4a, 0x61, 0x70, 0x61, 0x6e, 0x65,
  0x73, 0x65, 0x20, 0x6f, 0x77, 0x6e, 0x65, 0x72, 0x0a, 0x34, 0x38, 0x36,
  0x39, 0x31, 0x39, 0x7c, 0x32, 0x30, 0x32, 0x35, 0x2d, 0x30, 0x35, 0x2d,
  0x30, 0x38, 0x20, 0x31, 0x35, 0x3a, 0x33, 0x36, 0x3a, 0x34, 0x30, 0x7c,
  0x54, 0x72, 0x75, 0x6d, 0x70, 0x20, 0x61, 0x64, 0x6d, 0x69, 0x6e, 0x69,
  0x73, 0x74, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x63, 0x75, 0x74,
  0x20, 0x6d, 0x6f, 0x72, 0x65, 0x20, 0x74, 0x68, 0x61, 0x6e, 0x20, 0x24,
  0x31, 0x2e, 0x38, 0x20, 0x62, 0x69, 0x6c, 0x6c, 0x69, 0x6f, 0x6e, 0x20,
  0x69, 0x6e, 0x20, 0x4e, 0x49, 0x48, 0x20, 0x67, 0x72, 0x61, 0x6e, 0x74,
  0x73, 0x0a, 0x34, 0x38, 0x36, 0x39, 0x33, 0x31, 0x7c, 0x32, 0x30, 0x32,
  0x35, 0x2d, 0x30, 0x35, 0x2d, 0x30, 0x38, 0x20, 0x31, 0x33, 0x3a, 0x32,
  0x35, 0x3a, 0x30, 0x30, 0x7c, 0x55, 0x6e, 0x64, 0x65, 0x72, 0x77, 0x61,
  0x74, 0x65, 0x72, 0x20, 0x76, 0x6f, 0x6c, 0x63, 0x61, 0x6e, 0x6f, 0x20,
  0x6f, 0x66, 0x66, 0x20, 0x50, 0x61, 0x63, 0x69, 0x66, 0x69, 0x63, 0x20,
  0x63, 0x6f, 0x61, 0x73, 0x74, 0x20, 0x63, 0x6f, 0x75, 0x6c, 0x64, 0x20,
  0x73, 0x6f, 0x6f, 0x6e, 0x20, 0x65, 0x72, 0x75, 0x70, 0x74, 0x0a, 0x00
};

static const char *category_names[] =
{
    "top",
    "world",
    "business",
    "science",
    "technology",
    "health",
    "entertainment",
    "politics",
    "sports"
};

extern const char *topic_titles[];

void articles(void)
{
    int articles_on_this_page=0;
    char *page = strtok(articles_data,"\n");
    char *p = strtok(NULL,"|");
    unsigned long article_ids[6]={0,0,0,0,0,0};

    column_offset = 0;
    
    _fgColor = WHITE;
    _bgColor = BLUE;
    clrscr();

    // Title box
    _fgColor = WHITE;
    _bgColor = BLACK;
    box(0,0,max_cols-1,0);
    cputs((max_cols / 2) - (strlen(topic_titles[selected_topic]) / 2),0,topic_titles[selected_topic]);

    // Keys
    cputs(0,22,"U/D to Choose   PgUp/PgDn to Change Page  <- to Select Article  ESC for Topics");
    
    while (p != NULL)
    {
        char title[240];

        // Article box
        _fgColor = WHITE;
        _bgColor = BLUE;
        box(0,articles_on_this_page*4+1,max_cols-1,articles_on_this_page*4+1);
        _fgColor = BLACK;
        _bgColor = CYAN;
        box(0,articles_on_this_page*4+1+1,max_cols-1,articles_on_this_page*4+4+1);
        
        // Timestamp
        article_ids[articles_on_this_page] = atol(p);
        p=strtok(NULL,"|");
        cputs(max_cols-19,articles_on_this_page*4+1,p);

        /* // Title */
        memset(title,0,sizeof(title));
        p=strtok(NULL,"\n");
        strncpy(title,p,max_cols*3);
        cputs(0,articles_on_this_page*4+1+1,title);
        
        p = strtok(NULL, "|");

        articles_on_this_page++;
    }

    state=select(0,1,max_cols,4,articles_on_this_page,0,ARTICLE,TOPICS);
}
